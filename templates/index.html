<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Text-to-SQL</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
</head>

<body>

    <div class="chat-with-banner">
            <div class="side-banner">
                <img src="{{ url_for('static', filename='BanerOficiaTurFuc.jpg') }}" alt="Salom√≥n Mendoza" />
            </div>
        
            <div class="chat-section">
                <div class="topbar">
                    <div class="title">CONVERSI√ìN DE INSTRUCCIONES EN LENGUAJE NATURAL A CONSULTAS SQL EN BASES DE DATOS TRANSACCIONALES PARA PERSONAL NO T√âCNICO</div>
                    <div class="topbar-buttons">
                        <button class="btn-clear" onclick="clearChat()">üóë Limpiar Chat</button>
                    </div>
                </div>




                <div class="chat-container">
                    <div class="chat-box-area"></div>
                    <div id="chat-box" class="chat-box"></div>
                    <div class="input-box">
                        <input type="text" id="user-input" placeholder="Escriba una pregunta nueva..." />
                        <button onclick="sendMessage()">‚û§</button>
                    </div>
                </div>
    </div>
</div>





    <script>
        window.onload = function () {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = `
                    <div id="welcome-message" class="message-row bot">
                        <img class="avatar bot-avatar" src="/static/icon_salomon.jpg" alt="Bot" />
                        <div class="bot-message-block">
                            <div class="message bot">üëã ¬°Bienvenido! <strong> Soy un asistente inteligente dise√±ado para ayudarte a consultar bases de datos empresariales sin necesidad de saber SQL. </strong> ü§ñ
                                <p> Solo escribe lo que necesitas en lenguaje natural, y yo me encargar√© del resto.</p>
                                <center> <p> <strong>  Universidad P√∫blica de El Alto </strong></p> </center>
                                <p> Instituto de Investigaci√≥n de Ingenier√≠a de Sistemas </p>
                               <center><p> üîç Dise√±ado para profesionales sin experiencia t√©cnica: contadores, administradores, gerentes. </p>
                                <p> üìä Accede a informaci√≥n cr√≠tica sin depender de personal t√©cnico. </p>
                                <p> üß† Puedo transformar tus preguntas en lenguaje natural a consultas SQL autom√°ticas. </p></center>
                                </div>
                        </div>
                    </div>`;
            // Mensaje 2: despu√©s de 1 segundo
            setTimeout(() => {
                chatBox.innerHTML += `
            <div id="welcome-message-2" class="message-row bot">
                <img class="avatar bot-avatar" src="/static/icon_salomon.jpg" alt="Bot" />
                <div class="bot-message-block">
                    <div class="message bot"><p>¬øEn qu√© puedo ayudarte hoy?</p></div>
                </div>
            </div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 1000);


        };


        async function sendMessage() {
            const input = document.getElementById("user-input");
            const chatBox = document.getElementById("chat-box");
            const message = input.value;
            if (!message) return;

            // Mostrar mensaje del usuario
            chatBox.innerHTML += `
            <div class="message-row user">
                <img class="avatar user-avatar" src="/static/user.png" alt="Usuario" />
                <div class="message user">${message}</div>
            </div>`;

            input.value = "";


            // A√±adir mensaje "escribiendo..." del bot
            const loadingId = `loading-${Date.now()}`;
            chatBox.innerHTML += `
                    <div id="${loadingId}" class="message-row bot">
                        <img class="avatar bot-avatar" src="/static/icon_salomon.jpg" alt="Bot" />
                        <div class="bot-message-block">
                            <div class="message bot typing">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            </div>
                        </div>
                    </div>
                    `;

            chatBox.scrollTop = chatBox.scrollHeight;


            // Solicitud al backend principal /ask
            const response = await fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message })
            });
            const data = await response.json(); // Contiene data.answer
            const answer = data.answer || "No se obtuvo respuesta.";

            // Solicitud al backend /suggest
            let suggestions = [];
            try {
                const suggestionsResponse = await fetch("/suggest", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message })
                });
                const suggestionsData = await suggestionsResponse.json();
                suggestions = (suggestionsData.suggested_options || []).slice(0, 3);
            } catch (error) {
                console.warn("Error al obtener sugerencias:", error);
            }

            // Generar botones de sugerencia
            //const suggestionButtons = suggestions.map(text => `<button>‚öôÔ∏è ${text}</button>`).join("");
            const suggestionButtons = suggestions.map(text => `<button onclick="sendMessageWithText('${text}')">‚öôÔ∏è ${text}</button>`).join("");

            // Mostrar respuesta del bot + sugerencias
            chatBox.innerHTML += `
            <div class="message-row bot">
                <img class="avatar bot-avatar" src="/static/icon_salomon.jpg" alt="Bot" />
                <div class="bot-message-block">
                    <div class="message bot">${data.answer}</div>
                    <div class="options">
                        ${suggestionButtons}
                    </div>
                </div>
            </div>`;

            document.getElementById(loadingId)?.remove();

            // Scroll autom√°tico
            chatBox.scrollTop = chatBox.scrollHeight;

        }
        function sendMessageWithText(text) {
            document.getElementById("user-input").value = text;
            sendMessage();
        }

        function clearChat() {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = `
                <div id="welcome-message" class="message-row bot">
                    <img class="avatar bot-avatar" src="/static/icon_salomon.jpg" alt="Bot" />
                    <div class="bot-message-block">
                        <div class="message bot">¬°Hola! Soy <strong>Salom√≥n AI</strong> ü§ñ. Estoy aqu√≠ para ayudarte con temas contables. ¬øEn qu√© puedo ayudarte hoy?</div>
                    </div>
                </div>`;
        }

    </script>

</body>

</html>